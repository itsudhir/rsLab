###########################################################################
# Author: Sudhir Gupta
# Date: 05-May-2019
# Version: 1.0
# These CloudFormation templates are provided as a general guide. You should review and customize them to suit your needs. 
# Some of the resources deployed by these stacks incur costs as long as they are in use.
###########################################################################
AWSTemplateFormatVersion: 2010-09-09
Description: >-
  Creates a RedShift cluster within a VPC and not accessible from outside of VPC. **WARNING** This template creates an
  Amazon Redshift cluster of the size and instance type that you specify. You
  will be billed for the AWS resources used if you create a stack from this
  template. (qs-1ndudd5bm)
Parameters:
  VPC:
    Type: String
    Description: ID of the Cage's Virtual Private Cloud
    Type: 'AWS::EC2::VPC::Id'
    
  ClusterSubnetIDs:
    Type: String
    Description: Select private subnet(s) for Redshift Clusters in the above selected Virtual Private Cloud (VPC)
    Type: 'List<AWS::EC2::Subnet::Id>'
    
  DatabaseName:
    Description: >-
      The name of the first database to be created when the redshift cluster is created
    Type: String
    Default: defaultdb
    AllowedPattern: '([a-z]|[0-9])+'
    ConstraintDescription: must contain a-z or 0-9 only.
    
  ClusterType:
    Description: The type of the cluster
    Type: String
    Default: multi-node
    AllowedValues:
      - single-node
      - multi-node
    ConstraintDescription: must be single-node or multi-node.
    
  NumberOfNodes:
    Description: >-
      The nuber of compute nodes in the redshift cluster.  When cluster type is
      specified as single-node, the NumberOfNodes parameter should be specified
      as 1.  When cluster type is specified as multi-node, the NumberOfNodes
      parameter should be greater than 1
    Type: Number
    Default: '2'
    
  NodeType:
    Description: The node type to be provisioned for the redshift cluster
    Type: String
    Default: dc2.large
    AllowedValues:
      - dc2.large
      - dc2.8xlarge
      - ds2.xlarge
      - ds2.8xlarge
    ConstraintDescription: must be a valid RedShift node type.
    
  MasterUsername:
    Description: >-
      The user name associated with the master user account for the redshift
      cluster that is being created
    Type: String
    Default: rsadmin
    AllowedPattern: '([a-z])([a-z]|[0-9])*'
    ConstraintDescription: must start with a-z and contain only a-z or 0-9.
    
  MasterUserPassword:
    Description: >-
      The password associated with the master user account for the redshift
      cluster that is being created. 
    Type: String
    NoEcho: 'true'
    MinLength: '1'
    MaxLength: '41'
    Default: Welcome123
    AllowedPattern: >-
     ^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?!._*[@/\\\"']).*$
    ConstraintDescription: must contain only alphanumeric characters.
    
  InboundTraffic:
    Description: Allow inbound traffic to the cluster from this CIDR range.
    Type: String
    MinLength: '9'
    MaxLength: '18'
    Default: 0.0.0.0/0
    AllowedPattern: '(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})'
    ConstraintDescription: must be a valid CIDR range of the form x.x.x.x/x.
    
  RedshiftClusterPort:
    Description: >-
      The port that Redshift will listen on and that will be allowed through the Security Group. 
    Type: String
    Default: '5439'
    
  SnapshotIdentifier:
    Description: Leave it blank for new cluster. Enter Snapshot Identifier only if you want to restore from snapshot. 
    Type: String
    
  SnapshotAccountNumber:
    Description: "AWS Account number of Snapshot (Leave it blank, if snapshot is created in current AWS Account)"
    Type: String
    
  SubscriptionEmail:
    Type: String
    Description: Email address to notify when an API activity has triggered an alarm
    Default: 'youremail@xyz.com'
    #AllowedPattern: ^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\\.[a-zA-Z0-9-.]+$
    
  S3BucketForSpectrum:
    Description: >-
      Enter name of existing Amazon S3 bucket for Spectrum tables.
    Type: String
    Default: 'enter_your_bucket_name'
    
  Maintenancewindow:
    Description: Maintenance Window for Redshift Cluster
    Type: String
    Default: 'sat:05:00-sat:05:30'
    
  MaxConcurrentCluster:
    Description: Maximum Concurrency Scaling Redshift Clusters
    Type: String
    Default: '1'
    
  EncryptionAtRest:
    Description: >-
      Do you want to enable data encryption at rest?
    Type: String
    Default: false
    AllowedValues:
      - true
      - false
    ConstraintDescription: must be true or false.
  kmskey:
    Description: Provide valid KMS key ID. Leave this parameter empty for using AWS/Redshift managed KMS key.
    Type: String
    Default: ''

###########################################################################
# Mandatory tags that will be added to all resources that support tags
###########################################################################
  
  TagName:
    Type: String
    Description: Unique friendly name as required by the your company tagging strategy document and will be added to tag.
    Default: 'RedshiftDemo'

  TagEnvironment:
    Type: String
    AllowedValues:
      - Test
      - Production
    Description: The environment key is used to designate the production level of the associated AWS resource.
    Default: Test
    
  TagOwner:
    Type: String
    Description: The owner key is used to designate the your company individual associated with the given AWS resource.
    Default: 'youremail@xyz.com'
    
###############################################################################
# Parameter groups
###############################################################################

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      -
        Label:
          default: Environment of Application
        Parameters:
          - TagEnvironment          
      -
        Label:
          default: Redshift Network Parameters
        Parameters:
          - VPC    
          - ClusterSubnetIDs
          - InboundTraffic 
      -
        Label:
          default: Redshift Cluster Parameters
        Parameters:
          - ClusterType
          - NumberOfNodes
          - NodeType
          - DatabaseName
          - RedshiftClusterPort
          - MasterUsername
          - MasterUserPassword         
      -
        Label:
          default: Redshift additional/optional Parameters
        Parameters:
          - MaxConcurrentCluster
          - SnapshotIdentifier
          - SnapshotAccountNumber
          - S3BucketForSpectrum
          - SubscriptionEmail
          - EncryptionAtRest
          - kmskey
          - Maintenancewindow  
      -
        Label:
          default: Mandatory Custom Tags
        Parameters:
          - TagName
          - TagOwner

###############################################################################
# Conditions
###############################################################################
Conditions:
  IsMultiNodeCluster: !Equals [!Ref ClusterType, 'multi-node']
  IsEncryptionAtRest: !Equals [!Ref EncryptionAtRest, 'true']
  CreateProdResources: !Equals [ !Ref TagEnvironment, 'Production']
  CreateDevResources: !Not [!Equals [!Ref TagEnvironment, 'Production']]
  IsSnapshotSpecified:
    Fn::Not:
    - Fn::Equals:
      - ''
      - Ref: SnapshotIdentifier
  IsSnapshotAccountSpecified:
    Fn::Not:
    - Fn::Equals:
      - ''
      - Ref: SnapshotAccountNumber
###############################################################################
# Resources
###############################################################################

Resources:
  sns:
    Type: 'AWS::SNS::Topic'
    Properties:
      Subscription:
        - Endpoint: !Ref SubscriptionEmail
          Protocol: Email
      TopicName: !Join [ "-", [!Ref 'AWS::StackName',"SNS"]]
      
  SecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      VpcId: !Ref VPC
      GroupDescription: Security group
      SecurityGroupIngress:
        - CidrIp: !Ref InboundTraffic
          FromPort: !Ref RedshiftClusterPort
          ToPort: !Ref RedshiftClusterPort
          IpProtocol: tcp
          
  CFNMySpectrumRole:
   Type: AWS::IAM::Role
   Properties:
      RoleName: !Join [ "-", [!Ref 'AWS::StackName', "SpectrumRole"] ]
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          -
            Effect: "Allow"
            Principal:
              Service:
                - "redshift.amazonaws.com"
                - "glue.amazonaws.com"
            Action:
              - "sts:AssumeRole"
      Path: "/"
      Policies:
        -       
          PolicyName: !Join [ "-", [!Ref 'AWS::StackName', "spectrum-policy"] ]
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              -
                Effect: "Allow"
                Action:
                    - s3:GetBucketLocation
                    - s3:GetObject
                    - s3:ListMultipartUploadParts
                    - s3:ListBucket
                    - s3:ListBucketMultipartUploads
                Resource:
                    - !Join ['', ["arn:aws:s3:::", !Ref S3BucketForSpectrum]]
                    - !Join ['', ["arn:aws:s3:::", !Ref S3BucketForSpectrum, "/*"]]
              -
                Effect: "Allow"
                Action:
                    - s3:PutObject
                Resource:
                    - !Join ['', ["arn:aws:s3:::", !Ref S3BucketForSpectrum, "/tmp/*"]]
              -
                Effect: "Allow"
                Action:
                    - glue:CreateDatabase
                    - glue:DeleteDatabase
                    - glue:GetDatabase
                    - glue:GetDatabases
                    - glue:UpdateDatabase
                    - glue:CreateTable
                    - glue:DeleteTable
                    - glue:BatchDeleteTable
                    - glue:UpdateTable
                    - glue:GetTable
                    - glue:GetTables
                    - glue:BatchCreatePartition
                    - glue:CreatePartition
                    - glue:DeletePartition
                    - glue:BatchDeletePartition
                    - glue:UpdatePartition
                    - glue:GetPartition
                    - glue:GetPartitions
                    - glue:BatchGetPartition
                    - logs:*
                Resource:
                    - "*"
                    
  RedshiftClusterParameterGroup:
    Type: 'AWS::Redshift::ClusterParameterGroup'
    Properties:
      Description: Cluster parameter group
      ParameterGroupFamily: redshift-1.0
      Parameters:
        - ParameterName: enable_user_activity_logging
          ParameterValue: 'false'
        - ParameterName: require_ssl
          ParameterValue: 'true'
        - ParameterName: max_concurrency_scaling_clusters
          ParameterValue: !Ref MaxConcurrentCluster
        - ParameterName: "wlm_json_configuration"
          ParameterValue: "[{\"user_group\":[\"etlusers\"],\"query_group\":[\"etl\"],\"query_concurrency\":3,\"max_execution_time\":1800000,\"memory_percent_to_use\":35},{\"user_group\":[\"*ro*\"],\"user_group_wild_card\":1,\"query_concurrency\":8,\"concurrency_scaling\":\"auto\",\"max_execution_time\":120000,\"memory_percent_to_use\":45},{\"query_concurrency\":3,\"concurrency_scaling\":\"auto\",\"memory_percent_to_use\":15}]"
      Tags:
        -
          Key: Name
          Value: !Join [ "-", [ !Ref TagName, "Primary Cluster Parameter group" ] ]
        -
          Key: Environment
          Value: !Ref TagEnvironment
        -
          Key: Owner
          Value: !Ref TagOwner
          
  ClusterSubnetGroup:
    Type: 'AWS::Redshift::ClusterSubnetGroup'
    Properties:
      Description: RedshiftClusterSubnetGroup
      SubnetIds: !Ref ClusterSubnetIDs
             
  RedshiftCluster:
    Type: 'AWS::Redshift::Cluster'
    DependsOn: ClusterSubnetGroup
    Properties:
      ClusterType: !Ref ClusterType
      NumberOfNodes: !If 
        - IsMultiNodeCluster
        - !Ref NumberOfNodes
        - !Ref 'AWS::NoValue'
      NodeType: !Ref NodeType
      DBName: !Ref DatabaseName
      KmsKeyId: !If 
        - IsEncryptionAtRest
        - !Ref kmskey
        - !Ref 'AWS::NoValue'
      Encrypted: !Ref EncryptionAtRest
      Port: !Ref RedshiftClusterPort
      MasterUsername: !Ref MasterUsername
      MasterUserPassword: !Ref MasterUserPassword
      ClusterParameterGroupName: !Ref RedshiftClusterParameterGroup
      SnapshotIdentifier: !If 
        - IsSnapshotSpecified
        - !Ref SnapshotIdentifier
        - !Ref 'AWS::NoValue'
      OwnerAccount: !If 
        - IsSnapshotAccountSpecified
        - !Ref SnapshotAccountNumber
        - !Ref 'AWS::NoValue'
      VpcSecurityGroupIds:
        - !Ref SecurityGroup
      PreferredMaintenanceWindow: !Ref Maintenancewindow
      PubliclyAccessible: 'false'
      ClusterSubnetGroupName: !Ref ClusterSubnetGroup
      IamRoles: 
        - 'Fn::GetAtt':
            - CFNMySpectrumRole
            - Arn        
      Tags:
        -
          Key: Name
          Value: !Join [ "-", [ !Ref TagName, !Ref 'AWS::StackName', "redshift" ] ]
        -
          Key: Environment
          Value: !Ref TagEnvironment
        -
          Key: Owner
          Value: !Ref TagOwner
            
  DiskSpacealarmredshift:
    Type: 'AWS::CloudWatch::Alarm'
    DependsOn: RedshiftCluster
    Properties:
      MetricName: !Join 
        - ''
        - - !Ref RedshiftCluster
          - High-PercentageDiskSpaceUsed
      AlarmDescription: !Join 
        - ''
        - - DiskSpace Utilization > 85% for
          - !Ref RedshiftCluster
      Namespace: AWS/Redshift
      Statistic: Average
      Period: '300'
      EvaluationPeriods: '3'
      Threshold: '85'
      AlarmActions:
        - !Ref sns
      Dimensions:
        - Name: ClusterIdentifier
          Value: !Ref RedshiftCluster
      ComparisonOperator: GreaterThanThreshold
      Unit: Percent
      
  HighCPUutilizationalarmredshift:
    Type: 'AWS::CloudWatch::Alarm'
    DependsOn: RedshiftCluster
    Condition: CreateProdResources
    Properties:
      MetricName: !Join 
        - ''
        - - !Ref RedshiftCluster
          - High-CPUUtilization
      AlarmDescription: !Join 
        - ''
        - - CPUUtilization > 95% for last 30 min for cluster
          - !Ref RedshiftCluster
      Namespace: AWS/Redshift
      Statistic: Average
      Period: '900'
      EvaluationPeriods: '2'
      Threshold: '95'
      AlarmActions:
        - !Ref sns
      Dimensions:
        - Name: ClusterIdentifier
          Value: !Ref RedshiftCluster
      ComparisonOperator: GreaterThanThreshold
      Unit: Percent

###############################################################################
# Output Parameters
###############################################################################
 
Outputs:
  RedshiftHost:
    Description: Redshift Cluster Host
    Value: !GetAtt 
      - RedshiftCluster
      - Endpoint.Address
  RedshiftPort:
    Description: Redshift Cluster Port
    Value: !GetAtt 
      - RedshiftCluster
      - Endpoint.Port
  RedshiftDatabaseName:
    Description: Redshift Database Name
    Value: !Ref DatabaseName
  RedshiftUsername:
    Value: !Ref MasterUsername
  RedshiftClusterId:
    Value: !Ref RedshiftCluster    
  RedshiftParameterGroupName:
    Description: Name of the Redshift Parameter Group
    Value: !Ref RedshiftClusterParameterGroup
  RedshiftClusterEndpoint:
    Description: Redshift Cluster endpoint
    Value: !Join 
      - ':'
      - - !GetAtt 
          - RedshiftCluster
          - Endpoint.Address
        - !GetAtt
          - RedshiftCluster
          - Endpoint.Port
